Ti.include('biz_logic.js');var actualStartOfRelay=0;function getProjections(){var raceId=getRaceId();var pArray=new Array();var prevLegStart=getActualStartOfRelay();for(i=0;i<36;i++){legNum=i+1;var legResult=getLegResult(raceId,legNum,prevLegStart);pArray[i]=legResult;prevLegStart=legResult.legEnd;}
return pArray;}
function sendRaceProjections(teamPredictionKey,raceId,teamKey,handoffKey){Ti.API.info("sendRaceProjections - handoffKey: "+handoffKey);Ti.include('constants.js');var projArray=getProjections();var xhr=Ti.Network.createHTTPClient();xhr.onload=function(){Ti.API.info("hit onload function of sendRaceProjections")
try{Ti.API.info("sendProjections result: "+this.responseText);var doc=this.responseXML.documentElement;var content=doc.getElementsByTagName("row");var tpk=content.item(0).text;Ti.API.info("tpk: "+tpk);if(tpk.length>10){dbMain.execute("UPDATE team_identity SET team_prediction_key = ? WHERE team_id = 1",tpk);}
clearInterval(projectionStopWatch);}catch(ex){Ti.API.info('sendRaceProjections Error: '+ex);}};xhr.open('POST','http://sinequanonsolutions.appspot.com/predictor/upload');var data={};data.procid="1";data.shared_secret=SHARED_SECRET_VALUE;data.prediction_key=teamPredictionKey;data.race_id=getRaceId();data.team_key=teamKey;data.handoff_key=handoffKey;data.current_leg=getCurrentLeg();Ti.API.info("data.handoff_key: "+handoffKey);data.team_start=getActualStartOfRelay();for(var i=0;i<36;i++){var x=i+1;data["leg"+x]=projArray[i].state+projArray[i].legEnd;}
if((teamPredictionKey.length>10)&&(handoffKey.length>10)&&(teamKey.length>10)&&(Ti.Network.online==1)){xhr.send(data);}else{var rowTP=dbMain.execute("SELECT team_prediction_key, team_key FROM team_identity WHERE team_id = 1");if(rowTP.isValidRow()){teamPredictionKey=rowTP.field(0);teamKey=rowTP.field(1);}
rowTP.close();var rowHO=dbMain.execute("SELECT handoff_key FROM handoff_status WHERE handoff_id = 1");if(rowHO.isValidRow()){handoffKey=rowHO.field(0);}
rowHO.close();Ti.API.info('ERROR: send Race projections has a problem!');Ti.API.info('tpk: '+teamPredictionKey);Ti.API.info('hok: '+handoffKey);Ti.API.info('tk: '+teamKey);data.prediction_key=teamPredictionKey;data.team_key=teamKey;data.handoff_key=handoffKey;if(Ti.Network.online==1){xhr.send(data);}}};